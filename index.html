<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AquaStop - Zero-Waste Campus</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and Babel CDNs -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons UMD - Using the core library which is more stable in this environment -->
    <script src="https://unpkg.com/lucide@0.419.0/dist/umd/lucide.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
        body { font-family: 'Inter', sans-serif; overflow: hidden; margin: 0; padding: 0; }
        
        /* Custom scrollbar for dark mode */
        .dark-scroll::-webkit-scrollbar { width: 8px; }
        .dark-scroll::-webkit-scrollbar-track { background: #0f172a; }
        .dark-scroll::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        .dark-scroll::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* Smooth transition for theme switching */
        .transition-theme { transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease; }
        
        /* Chart styling */
        .chart-bar { transition: height 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useRef } = React;

        /**
         * Simple Icon Component to wrap Lucide UMD.
         * Renders a tag that Lucide's createIcons() will replace with an SVG.
         */
        const Icon = ({ name, size = 20, className = "", color = "currentColor", ...props }) => {
            const kebabName = name.replace(/([a-z0-9])([A-Z])/g, '$1-$2').toLowerCase();
            return (
                <i 
                    data-lucide={kebabName} 
                    className={className} 
                    style={{ width: size, height: size, color: color, display: 'inline-block' }}
                    {...props}
                ></i>
            );
        };

        const App = () => {
          const [activeTab, setActiveTab] = useState('consumption');
          const [darkMode, setDarkMode] = useState(true);
          const [isSpeaking, setIsSpeaking] = useState(false);
          const [appSettings, setAppSettings] = useState({
            apiKey: '',
            schoolName: 'Campus Alpha'
          });
          
          const TARIFF_JHB = 112.00;

          // Re-trigger Lucide icon replacement whenever the DOM changes (tab switch or theme change)
          useEffect(() => {
            if (window.lucide) {
                window.lucide.createIcons();
            }
          }, [activeTab, darkMode]);

          // AUDIT DATA: AUGUST 2025
          const meterData = [
            { date: '07/Aug/25', am: 67403, pm: 67412, night: 0, day: 9, total: 9 },
            { date: '08/Aug/25', am: 67452, pm: 67483, night: 40, day: 31, total: 71 },
            { date: '09/Aug/25', am: 67519, pm: 67531, night: 36, day: 12, total: 48 },
            { date: '10/Aug/25', am: 67573, pm: 67585, night: 42, day: 12, total: 54 },
            { date: '11/Aug/25', am: 67593, pm: 67617, night: 8, day: 24, total: 32 },
            { date: '12/Aug/25', am: 67669, pm: 67695, night: 52, day: 26, total: 78 },
            { date: '13/Aug/25', am: 67710, pm: 67736, night: 15, day: 26, total: 41 },
            { date: '14/Aug/25', am: 67777, pm: 67789, night: 41, day: 12, total: 53 },
            { date: '15/Aug/25', am: 67803, pm: 67829, night: 14, day: 26, total: 40 },
            { date: '16/Aug/25', am: 67860, pm: 67872, night: 31, day: 12, total: 43 },
            { date: '17/Aug/25', am: 67892, pm: 67904, night: 20, day: 12, total: 32 },
            { date: '18/Aug/25', am: 67947, pm: 67967, night: 43, day: 20, total: 63 },
            { date: '19/Aug/25', am: 67992, pm: 68018, night: 25, day: 26, total: 51 },
            { date: '20/Aug/25', am: 68030, pm: 68056, night: 12, day: 26, total: 38 },
            { date: '21/Aug/25', am: 68068, pm: 68094, night: 12, day: 26, total: 38 },
          ];

          const stats = useMemo(() => {
            const totalNight = meterData.reduce((acc, d) => acc + d.night, 0);
            const totalDay = meterData.reduce((acc, d) => acc + d.day, 0);
            const totalCons = totalNight + totalDay;
            const wastePercent = (totalNight / totalCons) * 100;
            const avgDailyCons = totalCons / meterData.length;
            const monthlyCons = avgDailyCons * 30;
            const monthlyRand = monthlyCons * TARIFF_JHB;
            const nightWasteRand = monthlyRand * (wastePercent / 100);
            const maxDayTotal = Math.max(...meterData.map(d => d.total));

            return { totalCons, wastePercent, monthlyRand, nightWasteRand, avgDailyCons, maxDayTotal };
          }, [meterData]);

          const speakInsights = async () => {
            if (isSpeaking) return;
            setIsSpeaking(true);

            const apiKey = appSettings.apiKey || "";

            const promptText = `AquaStop Meter Monitoring report for ${appSettings.schoolName}. Our audit discovery shows that ${stats.wastePercent.toFixed(1)} percent of the total water consumption is occurring outside of school hours. This equates to a monthly financial loss of approximately ${Math.round(stats.nightWasteRand)} Rand. We must prioritize night-flow management to reach our zero-waste campus goal.`;

            try {
              const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  contents: [{ parts: [{ text: promptText }] }],
                  generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                      voiceConfig: { prebuiltVoiceConfig: { voiceName: "Aoede" } }
                    }
                  },
                  model: "gemini-2.5-flash-preview-tts"
                })
              });

              const result = await response.json();
              if (result.error) throw new Error(result.error.message);
              
              const pcmData = result.candidates[0].content.parts[0].inlineData.data;
              const audioBlob = pcmToWav(pcmData, 24000);
              const audioUrl = URL.createObjectURL(audioBlob);
              const audio = new Audio(audioUrl);
              audio.onended = () => {
                setIsSpeaking(false);
                URL.revokeObjectURL(audioUrl);
              };
              audio.play();
            } catch (error) {
              console.error("Speech Synthesis Error:", error);
              setIsSpeaking(false);
            }
          };

          const pcmToWav = (base64Data, sampleRate) => {
            const byteCharacters = atob(base64Data);
            const buffer = new ArrayBuffer(byteCharacters.length);
            const byteArray = new Uint8Array(buffer);
            for (let i = 0; i < byteCharacters.length; i++) {
              byteArray[i] = byteCharacters.charCodeAt(i);
            }
            const header = new ArrayBuffer(44);
            const view = new DataView(header);
            const writeString = (offset, string) => {
              for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
              }
            };
            writeString(0, 'RIFF');
            view.setUint32(4, 36 + buffer.byteLength, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(36, 'data');
            view.setUint32(40, buffer.byteLength, true);
            return new Blob([header, buffer], { type: 'audio/wav' });
          };

          const SidebarItem = ({ id, icon, label }) => (
            <button
              onClick={() => setActiveTab(id)}
              className={`w-full flex items-center space-x-3 p-3 rounded-xl transition-all ${
                activeTab === id 
                  ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/40' 
                  : `${darkMode ? 'text-slate-400 hover:bg-slate-800' : 'text-slate-600 hover:bg-slate-100'}`
              }`}
            >
              <Icon name={icon} size={20} />
              <span className="font-semibold text-sm">{label}</span>
            </button>
          );

          return (
            <div className={`flex h-screen font-sans transition-theme ${darkMode ? 'bg-slate-950 text-slate-100' : 'bg-slate-50 text-slate-900'}`}>
              
              <aside className={`w-72 border-r p-6 flex flex-col transition-theme ${darkMode ? 'bg-slate-900 border-slate-800' : 'bg-white border-slate-200 shadow-sm'}`}>
                <div className="mb-10 px-2">
                  <div className="flex items-center space-x-3">
                    <div className="bg-blue-600 p-2 rounded-xl">
                      <Icon name="Droplets" className="text-white" size={24} />
                    </div>
                    <div>
                      <h1 className="text-xl font-bold tracking-tight leading-none uppercase italic">AquaStop</h1>
                      <span className="text-[10px] text-blue-500 font-bold uppercase tracking-widest leading-none">Zero-Waste Campus</span>
                    </div>
                  </div>
                </div>
                
                <nav className="space-y-2 flex-1">
                  <SidebarItem id="consumption" icon="Layers" label="Consumption Analysis" />
                  <SidebarItem id="twice-daily" icon="Camera" label="Twice Daily Monitoring" />
                  <SidebarItem id="meter-log" icon="Activity" label="Meter Log" />
                  <SidebarItem id="settings" icon="Settings" label="System Settings" />
                </nav>

                <div className="space-y-4">
                  <button onClick={speakInsights} disabled={isSpeaking} className={`w-full flex items-center justify-center space-x-2 p-3 rounded-xl border transition-all ${isSpeaking ? 'opacity-50 cursor-not-allowed' : 'hover:scale-[1.02] active:scale-[0.98]'} ${darkMode ? 'bg-slate-800 border-slate-700' : 'bg-slate-100 border-slate-200'}`}>
                    {isSpeaking ? <Icon name="Volume2" className="animate-pulse text-blue-500" /> : <Icon name="Headphones" size={18} className="text-blue-500" />}
                    <span className="text-xs font-bold uppercase tracking-widest">Listen to Insights</span>
                  </button>

                  <button onClick={() => setDarkMode(!darkMode)} className={`w-full flex items-center justify-between p-3 rounded-xl border transition-theme ${darkMode ? 'bg-slate-800 border-slate-700' : 'bg-slate-100 border-slate-200'}`}>
                    <span className="text-xs font-bold uppercase tracking-widest">{darkMode ? 'Dark Mode' : 'Light Mode'}</span>
                    {darkMode ? <Icon name="Moon" size={16} /> : <Icon name="Sun" size={16} />}
                  </button>

                  <div className={`p-4 rounded-2xl border transition-theme ${darkMode ? 'bg-slate-800/50 border-slate-700' : 'bg-slate-100 border-slate-200'}`}>
                    <div className="flex items-center space-x-2 mb-2">
                      <Icon name="Coins" size={14} className="text-yellow-500" />
                      <span className="text-[10px] font-black uppercase tracking-widest text-slate-400">TARIFF (JHB)</span>
                    </div>
                    <div className="flex justify-between items-end">
                      <span className="text-2xl font-mono font-bold text-blue-500">R112</span>
                      <span className="text-[10px] text-slate-500 pb-1 font-bold">per KL</span>
                    </div>
                  </div>
                </div>
              </aside>

              <main className="flex-1 overflow-y-auto p-8 lg:p-12 dark-scroll">
                {activeTab === 'consumption' && (
                  <div className="max-w-6xl mx-auto space-y-10 animate-in fade-in duration-500">
                    <header className="flex flex-col md:flex-row justify-between items-end gap-4">
                      <div>
                        <h2 className="text-4xl font-black tracking-tight uppercase italic leading-tight">AquaStop Meter Monitoring</h2>
                        <p className={`mt-1 font-medium ${darkMode ? 'text-slate-500' : 'text-slate-600'}`}>Analysis of {appSettings.schoolName} discovery audit. Day vs. Night Waste.</p>
                      </div>
                      <div className="flex items-center space-x-3 bg-blue-500/10 px-6 py-3 rounded-2xl border border-blue-500/20">
                        <Icon name="ShieldCheck" className="text-blue-500" size={20} />
                        <span className="text-xs font-bold uppercase tracking-widest">Audit Verified</span>
                      </div>
                    </header>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                      <div className={`p-8 rounded-[2.5rem] border relative overflow-hidden ${darkMode ? 'bg-slate-900 border-slate-800' : 'bg-white border-slate-200 shadow-sm'}`}>
                        <span className="text-[10px] font-black uppercase tracking-widest text-slate-500">Monthly Impact</span>
                        <p className="text-5xl font-black font-mono mt-2 leading-none">R{stats.monthlyRand.toLocaleString(undefined, {maximumFractionDigits: 0})}</p>
                        <div className="absolute top-0 right-0 p-6 opacity-5"><Icon name="Droplets" size={80} /></div>
                      </div>

                      <div className={`p-8 rounded-[2.5rem] border relative overflow-hidden ${darkMode ? 'bg-slate-900 border-slate-800' : 'bg-white border-slate-200 shadow-sm'}`}>
                        <span className="text-[10px] font-black uppercase tracking-widest text-slate-500">Night Waste</span>
                        <p className="text-5xl font-black font-mono mt-2 text-red-500 leading-none">R{stats.nightWasteRand.toLocaleString(undefined, {maximumFractionDigits: 0})}</p>
                        <div className="absolute top-0 right-0 p-6 opacity-5"><Icon name="ZapOff" size={80} /></div>
                      </div>

                      <div className="bg-blue-600 p-8 rounded-[2.5rem] shadow-xl text-white flex flex-col justify-center">
                        <Icon name="TrendingUp" size={20} className="mb-2" />
                        <p className="text-6xl font-black font-mono leading-none">{stats.wastePercent.toFixed(1)}%</p>
                        <p className="text-[10px] uppercase font-bold mt-3 opacity-80">Total consumption after-hours</p>
                      </div>
                    </div>

                    <div className={`p-8 rounded-[2.5rem] border ${darkMode ? 'bg-slate-900 border-slate-800' : 'bg-white border-slate-200 shadow-sm'}`}>
                      <div className="flex justify-between items-center mb-10 px-2">
                        <h3 className="text-xl font-bold uppercase tracking-tight italic">Consumption Profile: Night vs Day</h3>
                        <div className="flex space-x-6">
                          <div className="flex items-center space-x-2"><div className="w-3 h-3 bg-blue-500 rounded-full" /> <span className="text-[10px] font-bold text-slate-500 uppercase">Day Use</span></div>
                          <div className="flex items-center space-x-2"><div className="w-3 h-3 bg-red-500 rounded-full" /> <span className="text-[10px] font-bold text-slate-500 uppercase">Night Flow</span></div>
                        </div>
                      </div>
                      <div className="flex items-end justify-between space-x-3 h-72 border-b border-slate-800 pb-4 px-2">
                        {meterData.map((d, i) => {
                          const chartMax = stats.maxDayTotal * 1.2;
                          return (
                            <div key={i} className="flex-1 flex flex-col justify-end group relative h-full">
                              <div className="absolute -top-16 left-1/2 -translate-x-1/2 bg-blue-600 text-white p-2 rounded-lg text-[10px] font-bold opacity-0 group-hover:opacity-100 transition-all z-20 pointer-events-none shadow-xl whitespace-nowrap">
                                 Day: {d.day} KL / Night: {d.night} KL
                              </div>
                              <div className="w-full bg-blue-500 rounded-t-md transition-all group-hover:brightness-110 chart-bar" style={{ height: `${(d.day / chartMax) * 100}%` }} />
                              <div className="w-full bg-red-500/80 rounded-b-md mt-0.5 transition-all group-hover:brightness-110 chart-bar" style={{ height: `${(d.night / chartMax) * 100}%` }} />
                              <span className="text-[8px] text-slate-500 mt-4 text-center font-black uppercase tracking-tighter block w-full truncate">{d.date.split('/')[0]} {d.date.split('/')[1]}</span>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  </div>
                )}

                {activeTab === 'twice-daily' && (
                  <div className="max-w-5xl mx-auto space-y-10 animate-in slide-in-from-bottom-8">
                    <header className="text-center space-y-4">
                      <h2 className="text-4xl font-black uppercase italic leading-none">Twice Daily Monitoring</h2>
                      <p className="text-slate-500 font-medium">Capture AM and PM meter readings to maintain Zero-Waste status.</p>
                    </header>
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                      <div className={`p-8 rounded-[3rem] border flex flex-col items-center text-center space-y-6 ${darkMode ? 'bg-slate-900 border-slate-800 shadow-2xl' : 'bg-white border-slate-200 shadow-xl'}`}>
                        <div className="w-20 h-20 bg-blue-500/10 rounded-3xl flex items-center justify-center text-blue-500"><Icon name="Camera" size={40} /></div>
                        <h4 className="text-xl font-bold uppercase">Submit Reading</h4>
                        <div className="grid grid-cols-2 gap-3 w-full"><button className="bg-blue-600 text-white py-4 rounded-2xl font-black uppercase text-xs shadow-lg">6 AM Capture</button><button className={`py-4 rounded-2xl font-black uppercase text-xs shadow-lg ${darkMode ? 'bg-slate-700' : 'bg-slate-200 text-slate-700'}`}>6 PM Capture</button></div>
                      </div>
                      <div className={`p-8 rounded-[3rem] border space-y-6 ${darkMode ? 'bg-slate-900 border-slate-800 shadow-2xl' : 'bg-white border-slate-200 shadow-xl'}`}>
                        <h4 className="text-xs font-black uppercase text-slate-500 tracking-widest flex items-center gap-2"><Icon name="ShieldCheck" size={14} className="text-blue-500" /> Verification Protocol</h4>
                        <div className="space-y-5">
                          {["Staff captures meter at 06:00 and 18:00 daily", "Evidence sent to WhatsApp Bot", "OCR Engine extracts KL value", "Data published instantly"].map((step, i) => (
                            <div key={i} className="flex items-start space-x-4"><div className="mt-1"><Icon name="CheckCircle" size={18} className="text-blue-500" /></div><span className="text-sm font-semibold">{step}</span></div>
                          ))}
                        </div>
                      </div>
                    </div>
                    <div className={`p-10 rounded-[3rem] border ${darkMode ? 'bg-slate-900 border-slate-800 shadow-2xl' : 'bg-white border-slate-200 shadow-xl'}`}>
                      <h4 className="text-xl font-black uppercase italic mb-8">Verified Feed</h4>
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        {[
                          { time: '18:00 Today', type: 'PM Reading', val: '68,132' },
                          { time: '06:00 Today', type: 'AM Reading', val: '68,121' },
                        ].map((log, i) => (
                          <div key={i} className={`p-6 rounded-[2rem] flex items-center justify-between border ${darkMode ? 'bg-slate-800 border-slate-700' : 'bg-slate-50 border-slate-100'}`}>
                            <div className="flex items-center space-x-5"><div className="w-12 h-12 rounded-xl border-2 border-dashed border-slate-600 flex items-center justify-center"><Icon name="Camera" size={16} /></div><div><p className="font-black uppercase text-sm">{log.type}</p><p className="text-[10px] text-slate-500 uppercase font-bold">{log.time}</p></div></div>
                            <div className="text-right"><p className="font-mono font-black text-2xl text-blue-500 leading-none">{log.val}</p><span className="text-[9px] font-black uppercase text-slate-500">Verified</span></div>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                )}

                {activeTab === 'meter-log' && (
                  <div className="max-w-5xl mx-auto space-y-8 animate-in fade-in">
                    <h2 className="text-3xl font-black uppercase italic">Audit Archive</h2>
                    <div className={`rounded-3xl border overflow-hidden ${darkMode ? 'bg-slate-900 border-slate-800 shadow-2xl' : 'bg-white border-slate-200 shadow-lg'}`}>
                      <table className="w-full text-left">
                        <thead className={`text-[10px] font-black uppercase tracking-widest ${darkMode ? 'bg-slate-800 text-slate-400' : 'bg-slate-50 text-slate-500'}`}>
                          <tr><th className="p-6">Date</th><th className="p-6">AM</th><th className="p-6">PM</th><th className="p-6 text-red-500">Night Waste</th><th className="p-6 text-blue-500">Day Use</th><th className="p-6">Total</th></tr>
                        </thead>
                        <tbody className={`divide-y ${darkMode ? 'divide-slate-800' : 'divide-slate-100'}`}>
                          {meterData.map((row, i) => (
                            <tr key={i} className={`${darkMode ? 'hover:bg-slate-800/50' : 'hover:bg-slate-50'} transition-colors group`}>
                              <td className="p-6 font-bold text-sm">{row.date}</td>
                              <td className="p-6 font-mono text-blue-500 font-bold">{row.am.toLocaleString()}</td>
                              <td className="p-6 font-mono text-slate-400 font-bold">{row.pm.toLocaleString()}</td>
                              <td className="p-6 font-bold text-red-500">{row.night} KL</td>
                              <td className="p-6 font-bold text-blue-500">{row.day} KL</td>
                              <td className={`p-6 font-black text-sm group-hover:text-blue-500 transition-colors ${darkMode ? 'text-white' : 'text-slate-900'}`}>{row.total} KL</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>
                )}

                {activeTab === 'settings' && (
                  <div className="max-w-3xl mx-auto space-y-10">
                    <h2 className="text-4xl font-black uppercase italic leading-none">System Settings</h2>
                    <div className={`p-8 rounded-[3.5rem] border space-y-8 ${darkMode ? 'bg-slate-900 border-slate-800 shadow-2xl' : 'bg-white border-slate-200 shadow-lg'}`}>
                      <div className="space-y-4">
                        <div className="flex items-center space-x-2 text-blue-500"><Icon name="Key" size={20} /><h4 className="font-black uppercase tracking-tight">API Configuration</h4></div>
                        <input type="password" placeholder="KPI Key..." value={appSettings.apiKey} onChange={(e) => setAppSettings({...appSettings, apiKey: e.target.value})} className={`w-full p-5 rounded-2xl border font-mono text-sm transition-theme focus:ring-2 focus:ring-blue-500 outline-none ${darkMode ? 'bg-slate-800 border-slate-700 text-white' : 'bg-slate-50 border-slate-200'}`} />
                      </div>
                      <div className="space-y-4">
                        <div className="flex items-center space-x-2 text-blue-500"><Icon name="Database" size={20} /><h4 className="font-black uppercase tracking-tight">Facility Identity</h4></div>
                        <input type="text" value={appSettings.schoolName} onChange={(e) => setAppSettings({...appSettings, schoolName: e.target.value})} className={`w-full p-5 rounded-2xl border font-black text-sm transition-theme focus:ring-2 focus:ring-blue-500 outline-none ${darkMode ? 'bg-slate-800 border-slate-700 text-white' : 'bg-slate-50 border-slate-200'}`} />
                      </div>
                      <button onClick={() => setActiveTab('consumption')} className="bg-blue-600 text-white px-10 py-4 rounded-2xl font-black uppercase text-xs active:scale-95 transition-transform shadow-xl">Save Configuration</button>
                    </div>
                  </div>
                )}
              </main>
            </div>
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>